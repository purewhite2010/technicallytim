Title: Booting Debian with Systemd-boot and FDE
Date: 2023-07-02 09:50
Author: Tim White
Category: Blog, Technical
Tags: debian, systemd, luks, crypto
Slug: debian-systemd-boot-crypt

TLRD; Systemd-boot on Debian Buster 11 may be insecure due to how the default FDE is setup.

Fresh Debian Buster (11) install with Full Disk Encryption, should be great right? Having mostly Ubuntu for desktops for the last 10 years, and both Debian and Ubuntu as servers, I wanted to try Debian as a desktop again.

The install with FDE gave me a functioning system, with 3 partitions, the EFI partition, an encrypted root, and encrypted swap. No LVM (which really isn't needed on a desktop system with 1 main partition). While this works, I noticed that unlocking the encrypted root as boot time through Grub was taking 30 seconds. Some quick research revealed that Grub does't have optomised code for encryption, and so it's rather slow until it's decrypted the kernel and handed off to the Kernel and initrd. This was rather disappointing as it made booting really slow due to the extra 30 seconds to unlock the root partition to get the kernel and initrd. I knew my Ubuntu desktop system didn't have this issue, and oddly enough it didn't prompt for a password until it was past the Grub menu, so I knew Debian was doing something different to Ubuntu, and this was the source of the slowdown.

A quick investigation shows the main difference, the Ubuntu install with FDE and LVM uses an unecrypted `/boot` partition, the EFI partition, then a LUKS encrypted partition that then has LVM for split that into the root partition and the swap. This means Grub on Ubuntu can quickly load the initrd and kernel from the unencrypted `/boot`, hand off to the kernel, which then prompts for the LUKS password and can run the optomised decryption code, so the LUKS is mounted in a few seconds, and booting is less than 30 seconds total.

2 main solutions I found, setup an unencrypted `/boot` partition like Ubuntu, or look at using systemd-boot. I'd seen seen good things said about systemd-boot, and it was an easy option to try before sorting out unencrypted boot partitions. Mostly following the instructions from https://p5r.uk/blog/2020/using-systemd-boot-on-debian-bullseye.html I setup systemd-boot and gave the machine a reboot, given that this didn't require me to remove Grub, it gave me an easy way to test it. To my surprise, it booted really quickly, and didn't prompt for the LUKS password. ***WHAT!?!?*** Why didn't it prompt me to unlock the disk, how could it just unlock it? After a quick search down the rabbit hole of TPM2 auto unlocking LUKS, which wasn't setup, I finally discovered `/crypto_keyfile.bin` existed, and was set as a keyfile in slot 1 for both the root and swap partitions.

This didn't immediately let me know how systemd-boot was not prompting for a password, as the file was on the encrypted disk, but it did give me something to start looking for. I found a CVE that looked related, but after further investigation, it appeared it was only related to file permissions on the initrd which may contain the key, not how the key was accessible by systemd-boot while the disk was still locked. After much hunting, I finally found the smoking gun. `kernel-install` copies both the kernel and initrd from `/boot` into `/boot/efi/<machineid>/<kernelversion>/`, and `update-initramfs` see's the keyfile listed in `/etc/crypttab` and so copies it into the initrd so that it can unlock the system.

This confuses me a little, why does Debian have a keyfile to unlock LUKS disks, stored on the root encrypted disk, that requires a password to unlock first. Well, it's a simple solution to the problem of an unencrypted `/boot` partition, and the problem of an encrypted `/boot` partition that GRUB can't load the kernel from. GRUB unlocks the `/` root partition with the password you provide through GRUB, loads the kernel and initrd from the encrypted partition, and then hands off control to the kernel. With no way to pass the password from GRUB to the kernel, the kernel now needs to again unlock the root partition, so it uses the `/crypto_keyfile.bin` keyfile that now resides in the initrd (that was loaded into RAM by GRUB) to unlock the root partition and any other encrypted partitions.

So now systemd-boot is inadvertently making the system insecure, as it needs the kernel and initrd somewhere it can access without having to unlock anything, and so they are in the the unecrypted EFI partition. Unfortunately, because of how Debian and GRUB are setup, the initrd is now leaking the keyfile into the same EFI partition, making the security of the system non-existent now.

So now the problem is how to fix the keyfile leak, but still ensure we can unlock the disks.

My first rabbit hole was to try `KEYFILE_PATTERN` in `/etc/cryptsetup-initramfs/conf-hook` to try and make it not copy the `/crypto_keyfile.bin` file into the initrd. Unfortunately, setting KEYFILE_PATTERN to a empty, or undefined, did nothing. (A quick way to test was to rerun `sudo update-initramfs -u` and then check the initrd for the file `sudo lsinitramfs -l /boot/initrd.img-5.10.0-23-amd64 |grep crypto_keyfile.bin`). I didn't go down this rabbit hole too long, because I realised I don't really want an extra keyfile.

My next thing was to disable the keyfile, this can be done by deleting the keyslot on the luks partitions, and deleting the keyfile, but you need to also edit `/etc/crypttab` to have the word `none` as the keyfile/password field, and remove the `keyscript` option. After again running `update-initramfs`, verifying the file was no longer present with `sudo lsinitramfs -l /boot/initrd.img-5.10.0-23-amd64 |grep crypto_keyfile.bin`, and installing the updated kernel and initrd into the EFI partition with `sudo kernel-install -v add `uname -r` /boot/vmlinuz-`uname -r`, the system booted with systemd-boot, and then prompted for the password to unlock the root partition, and then prompted again to unlock the swap partition. So it's working, just slightly inconvenient as we now need to enter the boot password twice!

So now I had a secure system, it no longer leaked keyfiles, but it required the password twice to boot. The final part of the solution was found at https://unix.stackexchange.com/a/392286. The `decrypt_keyctl` script was already installed, and after editing `/etc/crypttab` to have `none` for the password, and `luks,discard,initramfs,keyscript=decrypt_keyctl` as the options, another round of update-initramfs and kernel-install, we finally have it working with a single password prompt, and no keyfile leaks!

Hopefully this helps someone else get Debian 11 running with Systemd-boot and FDE without leaking keys into their EFI partition.
